name: Update Music List
on:
  push:
    paths:
      - 'music/**'
    branches: [ main ]

jobs:
  generate-music-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup jq
      run: sudo apt-get install -y jq

    - name: Generate files.json
      run: |
        cd music
        # ç”Ÿæˆä¸¥æ ¼æ ¼å¼çš„æ–‡ä»¶åˆ—è¡¨
        ls -p | grep -vE '/|index\.html|files\.json' | while read -r file; do
          if [[ "$file" =~ [\"\\] ]]; then
            echo "å‘ç°éæ³•æ–‡ä»¶å: $file" >&2
            exit 1
          fi
          echo "$file"
        done | jq -R . | jq -s '{files: .}' > files.json
        
        # éªŒè¯ç”Ÿæˆç»“æœ
        if ! jq empty files.json; then
          echo "ç”Ÿæˆçš„æ–‡ä»¶JSONæ ¼å¼é”™è¯¯ï¼" >&2
          exit 1
        fi

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        if git diff --quiet --exit-code music/files.json; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
        else
          git add music/files.json
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°éŸ³ä¹åˆ—è¡¨"
          git push
          echo "å·²æäº¤å¹¶æ¨é€æ›´æ–°"
        fi